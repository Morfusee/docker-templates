http:
  routers:
    ferd:
      rule: "Host(`api.ferd.mcube.uk`)"
      entryPoints: [websecure]
      middlewares: [cors-ferd, default-chain]
      tls:
        certResolver: tlsresolver
      service: ferd-service
    
    n8n:
      rule: "Host(`auto.mcube.uk`)"
      entryPoints: [websecure]
      middlewares: [default-chain]
      tls:
        certResolver: tlsresolver
      service: n8n-service
    
    portal:
      rule: "Host(`api.portal.mcube.uk`)"
      entryPoints: [websecure]
      middlewares: [cors-portal, default-chain]
      tls:
        certResolver: tlsresolver
      service: portal-service

  services:
    ferd-service:
      loadBalancer:
        passHostHeader: true
        servers:
          - url: "http://ferd.home.production.mcube.uk"
    
    n8n-service:
      loadBalancer:
        passHostHeader: true
        servers:
          - url: "http://auto.home.development.mcube.uk"

    portal-service:
      loadBalancer:
        passHostHeader: true
        servers:
          - url: "http://desktop.hinny-carat.ts.net:3001"
    
  middlewares:
    base-cors:
      headers:
        accessControlAllowMethods: ["GET", "POST", "PUT", "DELETE", "PATCH"]
        accessControlAllowHeaders: ["Content-Type", "Authorization"]
        accessControlAllowCredentials: true
        accessControlMaxAge: 100
        addVaryHeader: true

    cors-ferd:
      chain:
        middlewares:
          - base-cors
      headers:
        accessControlAllowOriginList: ["https://ferd.mcube.uk"]

    cors-portal:
      chain:
        middlewares:
          - base-cors
      headers:
        accessControlAllowOriginList: ["*"]

    forwarded-headers:
      headers:
        customRequestHeaders:
          X-Forwarded-Proto: "https"

    security:
      headers:
        browserXssFilter: true
        contentTypeNosniff: true
        forceSTSHeader: true
        stsSeconds: 31536000
        stsIncludeSubdomains: true
        stsPreload: true
        frameDeny: true
        sslRedirect: true

    block-sensitive:
      redirectRegex:
        regex: "^.*(\\.env|\\.git|docker-compose\\.yml|\\.htaccess|\\.htpasswd|config\\.json).*$"
        replacement: "https://www.youtube.com/watch?v=xvFZjo5PgG0"
        permanent: true

    default-chain:
      chain:
        middlewares:
          - security
          - block-sensitive
          - forwarded-headers
